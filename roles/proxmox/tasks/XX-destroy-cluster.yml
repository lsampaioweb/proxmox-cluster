---
- name: Checking if the cluster already exists
  ansible.builtin.stat:
    path: "/etc/pve/corosync.conf"
  register: corosync

- name: Removing nodes from the cluster
  ansible.builtin.command: "pvecm delnode {{ item }}"
  when: ansible_hostname == cluster_master_node and ansible_hostname != item and corosync.stat.exists
  loop: "{{ groups['Proxmox'] }}"
  failed_when: false

- name: Destroying the cluster
  ansible.builtin.command: "{{ item }}"
  loop:
    - "systemctl stop pvestatd"
    - "systemctl stop pvedaemon"
    - "systemctl stop pve-cluster"
    - "systemctl stop corosync"
    - "pmxcfs -l"
    - "sqlite3 /var/lib/pve-cluster/config.db \"delete from tree where name = 'corosync.conf';\""
  register: "output"
  failed_when: output.rc != 0
  changed_when: output.rc != 0
  # failed_when: false

- name: Destroying the cluster
  ansible.builtin.command: "{{ item }}"
  loop:
    - "rm -f /var/lib/pve-cluster/.pmxcfs.lockfile"
    - "rm -f /etc/pve/corosync.conf"
    - "rm -rf /etc/corosync/*"
    - "rm -rf /var/lib/corosync/*"
  register: "output"
  failed_when: output.rc != 0
  changed_when: output.rc != 0
  # failed_when: false

- name: Destroying the cluster
  ansible.builtin.command: "{{ item }}"
  loop:
    - "killall pmxcfs"
    - "systemctl start pve-cluster"
    - "systemctl restart pveproxy"
    - "systemctl start pvedaemon"
    - "systemctl start pvestatd"
    - "pvecm updatecerts"
  register: "output"
  failed_when: output.rc != 0
  changed_when: output.rc != 0
  # failed_when: false

- name: Recursively remove directory
  ansible.builtin.file:
    path: "/etc/pve/nodes/{{ item }}"
    state: "absent"
  when: ansible_hostname != item
  loop: "{{ groups['Proxmox'] }}"
  register: "output"
  failed_when: output.rc != 0
  changed_when: output.rc != 0
  # failed_when: false
